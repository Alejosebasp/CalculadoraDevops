name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build and repackage with Spring Boot
        run: mvn clean package spring-boot:repackage -DskipTests

      - name: Build Docker image
        run: docker build -t spring-app .

      - name: Run Docker container
        run: docker run -d -p 8080:8080 --name app spring-app

      - name: Wait for app to be ready
        run: |
          for i in {1..15}; do
            if curl -s http://localhost:8080; then
              echo "App is up ✅"
              exit 0
            else
              echo "Waiting for app... attempt $i"
              sleep 5
            fi
          done
          echo "App did not start in time ❌"
          docker logs app
          exit 1

      - name: Install localtunnel
        run: |
          npm install -g localtunnel

      - name: Expose app with localtunnel
        run: |
          lt --port 8080 &

      - name: Test calculadora endpoint
        run: |
          echo "Probando endpoint /api/calculadora/sumar?a=5&b=7"
          curl -v "http://localhost:8080/api/calculadora/sumar?a=5&b=7"

      - name: Mostrar logs del contenedor
        run: docker logs app || echo "No se pudieron obtener los logs del contenedor"

