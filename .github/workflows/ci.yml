name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build and repackage with Spring Boot
        run: mvn clean package spring-boot:repackage -DskipTests

      - name: Build Docker image
        run: docker build -t spring-app .

      - name: Run Docker container
        run: docker run -d -p 8080:8080 --name app spring-app

      - name: Wait for app to be ready
        run: |
          for i in {1..15}; do
            if curl -s http://localhost:8080; then
              echo "App is up ✅"
              exit 0
            else
              echo "Waiting for app... attempt $i"
              sleep 5
            fi
          done
          echo "App did not start in time ❌"
          docker logs app
          exit 1

      - name: Descargar e instalar ngrok
        run: |
          curl -sL https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          chmod +x ngrok

      - name: Autenticarse con ngrok
        run: |
          ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Iniciar ngrok
        run: |
          nohup ./ngrok http 8080 &

      - name: Esperar a que ngrok genere la URL
        run: |
          echo "Esperando a que ngrok genere la URL del túnel..."
          sleep 5  # Espera 5 segundos para asegurar que ngrok haya iniciado

      - name: Obtener la URL del túnel ngrok
        run: |
          tunnel_url=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "La URL del túnel es: $tunnel_url"
          echo "NGROK_TUNNEL_URL=$tunnel_url" >> $GITHUB_ENV  # Guarda la URL como variable de entorno

      - name: Test calculadora endpoint
        run: |
          echo "Probando endpoint /api/calculadora/sumar?a=5&b=7"
          curl -v "$NGROK_TUNNEL_URL/api/calculadora/sumar?a=5&b=7"

      - name: Mostrar logs del contenedor
        run: docker logs app || echo "No se pudieron obtener los logs del contenedor"

